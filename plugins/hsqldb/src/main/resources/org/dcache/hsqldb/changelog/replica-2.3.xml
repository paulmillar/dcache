<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd">

    <changeSet author="behrmann" id="1">
        <comment></comment>

        <sql>
            CREATE SEQUENCE poolids
                INCREMENT BY 1
                START WITH 10001;

            CREATE TABLE pools
            (
                pool varchar(64) PRIMARY KEY,
                status varchar(128),
                datestamp timestamp without time zone,
                poolid integer GENERATED BY DEFAULT AS SEQUENCE poolids NOT NULL UNIQUE,
                countable boolean DEFAULT true
            );

            CREATE TABLE replicas
            (
                pool varchar(64) NOT NULL,
                pnfsid varchar(36) NOT NULL,
                datestamp timestamp without time zone,
                poolid integer NOT NULL,
                bitmask integer NOT NULL,
                countable boolean NOT NULL,
                excluded boolean NOT NULL,
                PRIMARY KEY (pool, pnfsid)
            );

            CREATE TABLE actions
            (
                "action" varchar(64) NOT NULL,
                spool varchar(64) NOT NULL,
                pnfsid varchar(36) NOT NULL,
                dpool varchar(64) NOT NULL,
                datestamp timestamp without time zone,
                "timestamp" bigint
            );

            CREATE TABLE configuration
            (
                label varchar(128) NOT NULL,
                value varchar(256),
                "comment" varchar(256)
            );

            CREATE TABLE deficient
            (
                pnfsid varchar(36),
                "count" integer
            );

            CREATE TABLE drainoff
            (
                pnfsid varchar(36)
            );

            CREATE TABLE excluded
            (
                pool varchar(64) NOT NULL,
                pnfsid varchar(36) NOT NULL,
                datestamp timestamp without time zone,
                "timestamp" bigint,
                poolid integer NOT NULL,
                bitmask integer NOT NULL,
                errcode varchar(64),
                errmsg varchar(512)
            );

            CREATE TABLE files
            (
                pnfsid varchar(36) PRIMARY KEY,
                datestamp timestamp without time zone DEFAULT now(),
                al integer,
                rp integer,
                fsize bigint,
                nmin integer,
                nmax integer,
                excluded boolean DEFAULT false,
                deleted boolean DEFAULT false,
                state integer,
                "valid" boolean DEFAULT true,
                sclass varchar(64)
            );

            CREATE TABLE heartbeat
            (
                process varchar(64) PRIMARY KEY,
                description varchar(256),
                datestamp timestamp without time zone
            );

            CREATE TABLE redundant
            (
                pnfsid varchar(36),
                "count" integer
            );

            CREATE UNIQUE INDEX poolid_idx ON pools (poolid);

            CREATE INDEX pools_pool_indx ON replicas (pool);

            CREATE INDEX replicas_pnfsid_indx ON replicas (pnfsid);

            CREATE TRIGGER add2files
                AFTER INSERT ON replicas
                REFERENCING NEW ROW AS new
                FOR EACH ROW
                INSERT INTO files (pnfsid, datestamp) VALUES (new.pnfsid, now());

            ALTER TABLE replicas
                ADD CONSTRAINT replicas_pool_fkey FOREIGN KEY (pool) REFERENCES pools(pool);

            ALTER TABLE replicas
                ADD CONSTRAINT replicas_poolid_fkey FOREIGN KEY (poolid) REFERENCES pools(poolid);

            INSERT INTO configuration VALUES ('version','1.0','Initial version');
        </sql>
    </changeSet>
</databaseChangeLog>
